<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .sidebar {
            width: 280px;
            height: 100vh;
            background: maroon;
            color: white;
            position: fixed;
            padding: 20px;
            transition: 0.3s;
            text-align: left;
        }

        .sidebar .logo {
            margin-bottom: 40px;
            text-align: center;
        }

        .sidebar .logo img {
            max-width: 100px;
            height: auto;
        }

        .sidebar ul {
            padding: 0;
            margin-top: 0;
        }

        .sidebar ul li {
            list-style: none;
            padding: 8px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .sidebar ul li i {
            width: 35px;
            font-size: 22px;
            text-align: center;
        }

        .sidebar ul li:hover {
            background: #a93226;
        }

        .sidebar .submenu {
            display: none;
            padding-left: 50px;
        }

        .sidebar .submenu li {
            font-size: 16px;
            padding: 5px 0;
        }

        .sidebar .has-submenu {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar .has-submenu i.arrow {
            transition: transform 0.3s;
        }

        .sidebar .has-submenu.open i.arrow {
            transform: rotate(90deg);
        }

        .main-content {
            flex-grow: 1;
            margin-left: 280px;
            padding-top: 80px;
            /* Tambahkan ini */
        }

        .header {
            position: fixed;
            top: 0;
            left: 280px;
            /* sesuai lebar sidebar */
            right: 0;
            height: 70px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0077b6;
            padding: 15px;
            border-bottom: 2px solid #ddd;
            color: white;
        }

        .title {
            font-size: 14px;
            font-weight: bold;
            margin: 0;
        }

        .subtitle {
            font-size: 12px;
            font-weight: normal;
            margin: 0;
        }

        .logout {
            cursor: pointer;
            font-size: 24px;
            color: #ffffff;
        }

        .logout:hover {
            color: #000000;
        }

        .table-container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">
            <img src="../Static/FKDK.png" alt="Logo" />
        </div>
        <ul>
            <li class="navigate" data-url="../Dashboard/Dashboard.html"><i class="fas fa-home"></i> Dashboard</li>
            <li class="has-submenu"><span><i class="fas fa-book"></i> Kesekretariatan</span> <i
                    class="fas fa-chevron-right arrow"></i></li>
            <ul class="submenu">
                <li class="navigate" data-url="../User/ProposalUser.html">proposal</li>
                <li class="navigate" data-url="../User/LPJUser.html">LPJ</li>
                <li class="navigate" data-url="../User/PersuratanUser.html">persuratan</li>
                <li class="navigate" data-url="../User/InventarisUser.html">inventaris</li>
            </ul>
            <li class="has-submenu"><span><i class="fas fa-coins"></i> Kebendaharaan</span> <i
                    class="fas fa-chevron-right arrow"></i></li>
            <ul class="submenu">
                <li class="navigate" data-url="../User/PemasukanUser.html">pemasukan</li>
                <li class="navigate" data-url="../User/PengeluaranUser.html">pengeluaran</li>
            </ul>
            <li class="has-submenu"><span><i class="fas fa-clock-rotate-left"></i> Riwayat</span> <i
                    class="fas fa-chevron-right arrow"></i></li>
            <ul class="submenu">
                <li class="has-submenu"><span>KESEKRETARIATAN</span> <i class="fas fa-chevron-right arrow"></i></li>
                <ul class="submenu">
                    <li class="navigate" data-url="../Riwayat/RiwayatProposal.html">proposal</li>
                    <li class="navigate" data-url="../Riwayat/RiwayatLPJ.html">LPJ</li>
                    <li class="navigate" data-url="../Riwayat/RiwayatPersuratan.html">persuratan</li>
                    <li class="navigate" data-url="../Riwayat/RiwayatInventaris.html">inventaris</li>
                </ul>
                <li class="has-submenu"><span>KEBENDAHARAAN</span> <i class="fas fa-chevron-right arrow"></i></li>
                <ul class="submenu">
                    <li class="navigate" data-url="../Riwayat/RiwayatPemasukan.html">pemasukan</li>
                    <li class="navigate" data-url="../Riwayat/RiwayatPengeluaran.html">pengeluaran</li>
                </ul>
            </ul>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <p class="title">FORUM KOMUNIKASI DAKWAH KAMPUS</p>
                <p class="subtitle">Universitas Singaperbangsa Karawang</p>
            </div>
            <div>
                <span id="username">Halo, User</span>
                <i class="fas fa-user-circle logout" id="logout"></i>
            </div>
        </div>

        <div class="container mt-4 table-container">
            <h3><i class="fas fa-book"></i> Data LRA</h3>
            <table class="table table-bordered table-striped" id="lraTable">
                <thead class="table-dark">
                    <tr id="lraHeader">
                        <th>No</th>
                        <th>Tanggal LRA Masuk</th>
                        <th>Proker Departemen</th>
                        <th>Nama Proker</th>
                        <th>Bendahara Pelaksana</th>
                        <th>Dokumen</th>
                        <th>Tanggal Disetujui</th>
                    </tr>
                </thead>
                <tbody id="lraBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const role = sessionStorage.getItem("role") || "user"; // Default ke 'user' jika tidak ada
            const username = sessionStorage.getItem("username") || "Demo User";

            if (role === "admin") {
                $("#username").text("Halo, Admin FKDK");
                $("#lraHeader").append("<th>Action</th>");
            } else {
                $("#username").text("Halo, " + username);
            }

            $(".has-submenu").click(function () {
                $(this).next(".submenu").slideToggle();
                $(this).toggleClass("open");
            });

            $(".navigate").click(function () {
                const url = $(this).data("url");
                window.location.href = url;
            });

            $("#logout").click(function () {
                alert("Anda telah logout!");
                sessionStorage.clear();
                window.location.href = "../Login/Login.html";
            });

            function loadRiwayatLRA() {
                // Ambil data dari backend Flask
                fetch('http://127.0.0.1:5000/get_lras') // Sesuaikan URL Flask Anda
                    .then(response => response.json())
                    .then(data => {
                        $("#lraBody").empty();
                        data.forEach((item, index) => {
                            let dokumenCell = '-';
                            if (item.dokumenName && item.dokumenBase64) {
                                dokumenCell = `<a href="http://127.0.0.1:5000/download_lra/${item.id}" target="_blank" class="btn btn-sm btn-primary download-btn" data-id="${item.id}">
                                <i class="fas fa-download me-1"></i> Download File
                            </a>`;
                            } else if (item.dokumenName) {
                                // Jika dokumenBase64 tidak ada tapi ada nama, berarti dokumen tidak ada di DB atau ada error
                                // ini bisa terjadi jika data lama tidak punya base64
                                dokumenCell = `<span class="text-danger">File tidak tersedia</span>`;
                            }


                            let row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.tanggalMasuk || '-'}</td>
                                <td>${item.departemen || '-'}</td>
                                <td>${item.namaProker || '-'}</td>
                                <td>${item.bendahara || '-'}</td>
                                <td>${dokumenCell}</td>
                                <td>${item.tanggalDisetujui || '-'}</td>`;

                            if (role === "admin") {
                                row += `
                                <td>
                                    <button class="btn btn-warning btn-sm edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Delete</button>
                                </td>`;
                            }

                            row += `</tr>`;
                            $("#lraBody").append(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching lras:', error);
                        alert("Terjadi kesalahan saat memuat data LRA.");
                    });
            }

            loadRiwayatLRA(); // Panggil fungsi untuk memuat data saat halaman dimuat

            // Event handler untuk tombol Edit
            $("#lraTable").on("click", ".edit-btn", function () {
                const row = $(this).closest("tr");
                const cols = row.find("td");
                const lraId = $(this).data("id"); // Ambil ID LRA dari data-id
                let currentData = {};

                if ($(this).text().includes("Edit")) {
                    // Ambil data saat ini dari tabel sebelum mengedit
                    currentData = {
                        tanggalMasuk: $(cols[1]).text(),
                        departemen: $(cols[2]).text(),
                        namaProker: $(cols[3]).text(),
                        bendahara: $(cols[4]).text(),
                        tanggalDisetujui: $(cols[6]).text()
                    };

                    $(cols[1]).html(`<input type="date" class="form-control form-control-sm" value="${currentData.tanggalMasuk}">`);
                    for (let i = 2; i <= 4; i++) {
                        const text = $(cols[i]).text();
                        $(cols[i]).html(`<input type="text" class="form-control form-control-sm" value="${text}">`);
                    }

                    $(cols[5]).html(`<input type="file" class="form-control form-control-sm" id="editDokumenFile" accept=".pdf,.doc,.docx">`);

                    $(cols[6]).html(`
                    <select class="form-select form-select-sm" id="editStatusTanggal">
                        <option value="-"> - </option>
                        <option value="tanggal">Pilih Tanggal</option>
                    </select>
                    <input type="date" class="form-control form-control-sm mt-1" id="editTanggalDisetujuiPicker" style="display:none;">`
                    );

                    if (currentData.tanggalDisetujui && currentData.tanggalDisetujui !== '-') {
                        $("#editStatusTanggal").val("tanggal");
                        $("#editTanggalDisetujuiPicker").val(currentData.tanggalDisetujui).show();
                    }

                    $("#editStatusTanggal").off('change').on('change', function () {
                        if ($(this).val() === "tanggal") {
                            $("#editTanggalDisetujuiPicker").show();
                        } else {
                            $("#editTanggalDisetujuiPicker").hide();
                        }
                    });

                    $(this).html('<i class="fas fa-save"></i> Save');
                } else {
                    // Mode Save
                    const updatedData = {
                        tanggalMasuk: $(cols[1]).find("input").val(),
                        departemen: $(cols[2]).find("input").val(),
                        namaProker: $(cols[3]).find("input").val(),
                        bendahara: $(cols[4]).find("input").val(),
                        tanggalDisetujui: ($("#editStatusTanggal").val() === "tanggal") ? $("#editTanggalDisetujuiPicker").val() : null // Simpan null jika tidak ada tanggal
                    };

                    const fileInput = $(cols[5]).find("#editDokumenFile")[0];
                    let hasNewFile = false;

                    if (fileInput && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const allowedTypes = ["application/pdf", "application/msword", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"];
                        if (!allowedTypes.includes(file.type)) {
                            alert("Jenis file tidak didukung. Harap unggah PDF atau DOC/DOCX.");
                            return;
                        }
                        hasNewFile = true;
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            updatedData.dokumenName = file.name;
                            updatedData.dokumenBase64 = event.target.result; // Base64 data
                            sendUpdate(lraId, updatedData);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Jika tidak ada file baru, ambil dokumenName dan dokumenBase64 dari server
                        fetch(`http://127.0.0.1:5000/get_lras`) // Ambil data lengkap untuk mendapatkan dokumen
                            .then(res => res.json())
                            .then(lras => {
                                const originalLRA = lras.find(p => p.id === lraId);
                                if (originalLRA) {
                                    updatedData.dokumenName = originalLRA.dokumenName;
                                    updatedData.dokumenBase64 = originalLRA.dokumenBase64;
                                }
                                sendUpdate(lraId, updatedData);
                            });
                    }

                    function sendUpdate(id, dataToUpdate) {
                        fetch(`http://127.0.0.1:5000/update_lra/${id}`, { // Sesuaikan URL Flask Anda
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dataToUpdate)
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (result.message) {
                                    alert(result.message);
                                    $(this).html('<i class="fas fa-edit"></i> Edit');
                                    loadRiwayatLRA(); // Muat ulang data setelah update
                                } else {
                                    alert("Error: " + result.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error updating LRA:', error);
                                alert("Terjadi kesalahan saat mengupdate LRA.");
                            });
                    }
                }
            });

            // Event handler untuk tombol Delete
            $("#lraTable").on("click", ".delete-btn", function () {
                if (confirm("Yakin ingin menghapus data ini?")) {
                    const lraId = $(this).data("id"); // Ambil ID LRA dari data-id

                    fetch(`http://127.0.0.1:5000/delete_lra/${lraId}`, { // Sesuaikan URL Flask Anda
                        method: 'DELETE'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                alert(data.message);
                                loadRiwayatLRA(); // Muat ulang data setelah delete
                            } else {
                                alert("Error: " + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting LRA:', error);
                            alert("Terjadi kesalahan saat menghapus LRA.");
                        });
                }
            });
        });
    </script>
</body>

</html>